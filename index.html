<!doctype html>

<html lang="es" data-theme="dark">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Biblioteca FRGP</title>
  <meta name="description" content="Parciales, finales y material de estudio de la FRGP/UTN." />
  <style>
    :root {
      color-scheme: dark;
      --font-base: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      --transition-speed: 150ms;
      --wrap-width: min(1440px, calc(100% - 528px));
      --bg: #0b0d10;
      --panel: #12151a;
      --panel-border: #1f242c;
      --panel-muted: rgba(255,255,255,0.04);
      --text: #e6e8eb;
      --text-muted: #9aa3ad;
      --accent: #4ea1ff;
      --danger: #ff6b6b;
      --success: #61d095;
      --shadow: 0 16px 40px rgba(0, 0, 0, 0.35);
    }

    [data-theme="light"] {
      --bg: #f6f8fb;
      --panel: #ffffff;
      color-scheme: light;
      --panel-border: #dfe5ee;
      --panel-muted: rgba(0,0,0,0.04);
      --text: #101418;
      --text-muted: #5b6876;
      --accent: #0f6aff;
      --danger: #d94343;
      --success: #1f8a5b;
      --shadow: 0 12px 30px rgba(15, 33, 55, 0.12);
    }

    *, *::before, *::after { box-sizing: border-box; }

    html, body {
      margin: 0;
      min-height: 100%;
      font-family: var(--font-base);
      background: var(--bg);
      color: var(--text);
    }

    body.has-overlay {
      overflow: hidden;
    }

    a {
      color: inherit;
    }

    .page {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      justify-content: center;
      position: relative;
      gap: 0;
    }

    .wrap {
      max-width: var(--wrap-width);
      margin: 0 auto;
      padding: 32px 24px 72px;
    }

    @media (max-width: 1200px) {
      .wrap {
        padding: 24px 18px 64px;
      }
    }

    header.site {
      display: grid;
      grid-template-columns: minmax(0, 1fr) auto;
      gap: 12px;
      align-items: center;
      margin-bottom: 18px;
    }

    header .title {
      display: flex;
      gap: 12px;
      align-items: baseline;
      flex-wrap: wrap;
    }

    header .title h1 {
      margin: 0;
      font-size: clamp(1.35rem, 1.1rem + 0.5vw, 1.8rem);
      letter-spacing: 0.2px;
    }

    header .title .tagline {
      margin: 0;
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    button,
    select,
    input[type="search"] {
      font: inherit;
      border-radius: 12px;
      border: 1px solid var(--panel-border);
      background: var(--panel);
      color: inherit;
      padding: 10px 12px;
      transition: background-color var(--transition-speed) ease, border-color var(--transition-speed) ease, color var(--transition-speed) ease, transform var(--transition-speed) ease;
      box-shadow: var(--shadow);
    }

    button {
      cursor: pointer;
    }

    button:focus-visible,
    select:focus-visible,
    input[type="search"]:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 3px;
    }

    button[data-variant="ghost"] {
      box-shadow: none;
      background: transparent;
      border-color: transparent;
      padding: 8px 10px;
    }

    button[data-variant="ghost"]:hover {
      background: var(--panel-muted);
    }

    .theme-toggle {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.9rem;
    }

    .toolbar {
      display: grid;
      grid-template-columns: minmax(0, 1fr) auto auto;
      gap: 12px;
      align-items: center;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    @media (max-width: 900px) {
      .toolbar {
        grid-template-columns: minmax(0, 1fr);
      }
      .toolbar select,
      .toolbar button[data-action="up"] {
        width: 100%;
      }
    }

    .toolbar .search {
      position: relative;
      display: flex;
      align-items: center;
    }

    .toolbar .search input {
      width: 100%;
      padding-left: 42px;
    }

    .toolbar .search svg {
      position: absolute;
      left: 14px;
      width: 18px;
      height: 18px;
      color: var(--text-muted);
    }

    nav.breadcrumbs {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 0.9rem;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    nav.breadcrumbs a {
      color: inherit;
      text-decoration: none;
      border-radius: 8px;
      padding: 2px 6px;
      transition: background-color var(--transition-speed) ease;
    }

    nav.breadcrumbs a:hover,
    nav.breadcrumbs a:focus-visible {
      background: var(--panel-muted);
      color: var(--text);
      outline: none;
    }

    .panel {
      background: var(--panel);
      border: 1px solid var(--panel-border);
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    table.listing {
      width: 100%;
      border-collapse: collapse;
    }

    table.listing thead {
      background: var(--panel-muted);
    }

    table.listing th,
    table.listing td {
      padding: 14px 18px;
      text-align: left;
      border-bottom: 1px solid var(--panel-border);
    }

    table.listing tbody tr {
      transition: background-color var(--transition-speed) ease, transform var(--transition-speed) ease;
    }

    table.listing tbody tr:hover {
      background: var(--panel-muted);
    }

    .cell-name {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .cell-name svg {
      flex-shrink: 0;
      width: 24px;
      height: 24px;
    }

    .cell-name a,
    .cell-name button {
      background: none;
      border: none;
      padding: 0;
      color: inherit;
      font: inherit;
      cursor: pointer;
      text-align: left;
    }

    .cell-name a:hover,
    .cell-name button:hover {
      text-decoration: underline;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
      background: var(--panel-muted);
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .empty-state {
      padding: 32px;
      text-align: center;
      color: var(--text-muted);
    }

    .footer-note {
      margin-top: 24px;
      font-size: 0.95rem;
      color: var(--text-muted);
    }

    .footer-note strong {
      color: var(--text);
    }

    details.helper {
      margin-top: 18px;
      border: 1px dashed var(--panel-border);
      border-radius: 12px;
      padding: 16px 18px;
      background: var(--panel-muted);
    }

    details.helper summary {
      cursor: pointer;
      font-weight: 600;
    }

    details.helper summary:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 4px;
    }

    details.helper ol {
      padding-left: 18px;
      margin: 14px 0 0;
    }

    details.helper code {
      background: rgba(0,0,0,0.18);
      padding: 2px 6px;
      border-radius: 6px;
      font-size: 0.9rem;
    }

    [data-theme="light"] details.helper code {
      background: rgba(15,15,20,0.12);
    }

    .ad-rail {
      position: fixed;
      top: 0;
      bottom: 0;
      width: 240px;
      display: flex;
      align-items: stretch;
      justify-content: center;
      padding: 12px;
      pointer-events: none;
    }
    .ad-rail > div {
      width: 100%;
      min-height: 320px;
      height: 100%;
      border-radius: 16px;
      border: 1px dashed var(--panel-border);
      background: var(--panel-muted);
      color: var(--text-muted);
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 16px;
      pointer-events: auto;
    }

    .ad-rail.left {
      left: 0;
    }

    .ad-rail.right {
      right: 0;
    }

    @media (max-width: 1600px) {
      .ad-rail {
        display: none;
      }
      :root {
        --wrap-width: min(1120px, calc(100% - 32px));
      }
    }

    #previewOverlay {
      position: fixed;
      inset: 0;
      background: rgba(9, 12, 16, 0.76);
      backdrop-filter: blur(2px);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 48px 24px;
      z-index: 999;
      opacity: 0;
      pointer-events: none;
      transition: opacity var(--transition-speed) ease;
    }

    #previewOverlay.is-visible {
      opacity: 1;
      pointer-events: auto;
    }

    .preview-shell {
      position: relative;
      width: min(1024px, 100%);
      height: min(90vh, 100%);
      background: var(--panel);
      border-radius: 20px;
      box-shadow: 0 30px 60px rgba(0,0,0,0.4);
      display: flex;
      flex-direction: column;
      border: 1px solid var(--panel-border);
      overflow: hidden;
    }

    .viewer-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      border-bottom: 1px solid var(--panel-border);
      gap: 12px;
    }

    .viewer-header h2 {
      font-size: 1rem;
      margin: 0;
      max-width: calc(100% - 42px);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .viewer-close {
      background: transparent;
      border: none;
      color: inherit;
      font-size: 1.35rem;
      line-height: 1;
      padding: 6px 10px;
      min-width: 44px;
      min-height: 44px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border-radius: 999px;
      transition: background-color var(--transition-speed) ease, transform var(--transition-speed) ease;
    }

    .viewer-close:hover,
    .viewer-close:focus-visible {
      background: var(--panel-muted);
      outline: none;
    }

    .viewer-body {
      flex: 1 1 auto;
      overflow: auto;
      background: #1f242c;
      position: relative;
    }

    [data-theme="light"] .viewer-body {
      background: #f1f5fb;
    }

    .viewer-body iframe,
    .viewer-body canvas,
    .viewer-body .pdf-page {
      width: 100%;
    }

    .viewer-body .pdf-pages {
      display: flex;
      flex-direction: column;
      gap: 16px;
      padding: 16px;
    }

    .viewer-body .pdf-page canvas {
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.35);
      background: #fff;
    }

    .viewer-loader {
      position: absolute;
      inset: 0;
      display: grid;
      place-items: center;
      background: rgba(0,0,0,0.35);
      color: #fff;
      font-size: 0.95rem;
    }

    [data-theme="light"] .viewer-loader {
      background: rgba(255,255,255,0.7);
      color: #101418;
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0,0,0,0);
      white-space: nowrap;
      border: 0;
    }

    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        transition-duration: 0.01ms !important;
        animation-duration: 0.01ms !important;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <aside class="ad-rail left" aria-label="Espacio para anuncios" data-rail>
      <div>Reservado para anuncio lateral izquierdo (240×600)</div>
    </aside>
    <main class="wrap" id="app" tabindex="-1">
      <header class="site">
        <div class="title">
          <h1>Biblioteca FRGP</h1>
          <p class="tagline">Parciales, finales y material colaborativo</p>
        </div>
        <div class="actions">
          <button type="button" class="theme-toggle" id="themeToggle" aria-live="polite" aria-pressed="false">
            <span aria-hidden="true">🌙</span>
            <span class="label">Tema oscuro</span>
          </button>
        </div>
      </header>

      <nav class="breadcrumbs" aria-label="Ruta" id="breadcrumbs"></nav>

      <div class="panel" role="region" aria-live="polite">
        <div class="toolbar">
          <label class="search">
            <span class="sr-only">Buscar materia o archivo</span>
            <svg aria-hidden="true" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="7"></circle><line x1="16.65" y1="16.65" x2="21" y2="21"></line></svg>
            <input type="search" id="searchInput" placeholder="Buscar…" autocomplete="off" spellcheck="false" />
          </label>
          <select id="sortSelect" aria-label="Ordenar por">
            <option value="name">Ordenar A → Z</option>
            <option value="date">Más recientes primero</option>
          </select>
          <button type="button" data-action="up" id="upButton">Subir nivel</button>
        </div>

        <table class="listing" role="grid" aria-describedby="listingInfo">
          <thead>
            <tr>
              <th scope="col">Nombre</th>
              <th scope="col">Tipo</th>
              <th scope="col">Fecha</th>
            </tr>
          </thead>
          <tbody id="listingBody"></tbody>
        </table>
        <div class="empty-state" id="emptyState" hidden>No encontramos nada con ese criterio.</div>
      </div>

      <p class="footer-note" id="contactNote"></p>
      <details class="helper">
        <summary>Cómo sumar nuevo material</summary>
        <ol>
          <li>Nombrá el archivo siguiendo el formato <code>Carpeta_Subcarpeta_Subcarpeta_NombreDelArchivo.pdf</code>. Ejemplo: <code>Basicas_FisicaI_Parciales_TP1.pdf</code>.</li>
          <li>Copiá el PDF en la carpeta <code>/files</code> del repositorio (podés arrastrarlo desde el explorador o usar Git).</li>
          <li>Ejecutá <code>npm run ingest</code> o <code>node tools/ingest-files.mjs</code>. El script separa los segmentos con <code>_</code>, arma la ruta con los tres primeros (Carpeta/Subcarpeta/Subcarpeta) y crea la entrada del PDF en <code>index.json</code>.</li>
          <li>Verificá que aparezca en la sección correcta y hacé commit de <code>index.json</code> y del PDF nuevo.</li>
        </ol>
        <p>Si necesitás más niveles (por ejemplo año → materia → parciales) adaptá el nombre respetando el orden y actualizá el script en <code>tools/ingest-files.mjs</code>.</p>
      </details>
    </main>
    <aside class="ad-rail right" aria-label="Espacio para anuncios" data-rail>
      <div>Reservado para anuncio lateral derecho (240×600)</div>
    </aside>
  </div>

  <div id="previewOverlay" role="dialog" aria-modal="true" aria-labelledby="viewerTitle" hidden>
    <div class="preview-shell">
      <div class="viewer-header">
        <h2 id="viewerTitle"></h2>
        <button type="button" class="viewer-close" id="viewerClose" aria-label="Cerrar vista previa">✕</button>
      </div>
      <div class="viewer-body" id="viewerBody">
        <div class="viewer-loader" id="viewerLoader" hidden>Cargando vista previa…</div>
      </div>
    </div>
  </div>

  <script type="module">
    const CONTACT_EMAIL = 'examenes@tu-dominio.com';
    const DATA_URL = 'index.json';
    const STORAGE_KEY_THEME = 'frgp-theme';
    const DEFAULT_SORT = 'name';

    const breadcrumbsEl = document.getElementById('breadcrumbs');
    const listingBodyEl = document.getElementById('listingBody');
    const emptyStateEl = document.getElementById('emptyState');
    const searchInputEl = document.getElementById('searchInput');
    const sortSelectEl = document.getElementById('sortSelect');
    const upButtonEl = document.getElementById('upButton');
    const contactNoteEl = document.getElementById('contactNote');
    const themeToggleEl = document.getElementById('themeToggle');
    const overlayEl = document.getElementById('previewOverlay');
    const overlayTitleEl = document.getElementById('viewerTitle');
    const overlayBodyEl = document.getElementById('viewerBody');
    const overlayCloseEl = document.getElementById('viewerClose');
    const overlayLoaderEl = document.getElementById('viewerLoader');
    const prefersLightScheme = window.matchMedia ? window.matchMedia('(prefers-color-scheme: light)') : null;
    let datasetRoot = null;
    let currentNode = null;
    let currentPath = [];
    let searchTerm = '';
    let sortMode = DEFAULT_SORT;
    let lastFocusedElement = null;
    let pdfjsReady = false;
    let isOverlayOpen = false;
    let activePreviewToken = 0;
    const icons = {
      folder: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7a2 2 0 0 1 2-2h4l2 2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2Z" /></svg>',
      file: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M7 2h8l5 5v13a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2Z" /><path d="M13 2v6h6" /></svg>',
      pdf: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M6 4h7l5 5v11a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2Z" /><path d="M12 12h2.5a1.5 1.5 0 0 1 0 3H12v-5" /><path d="M8 12h1.5a1.5 1.5 0 0 1 0 3H8v-5" /><path d="M12 15h1.5" /></svg>'
    };

    const formatters = {
      date(value) {
        if (!value) return '—';
        const date = typeof value === 'string' ? new Date(value) : value;
        if (Number.isNaN(date.getTime())) return '—';
        return date.toLocaleDateString('es-AR', { year: 'numeric', month: 'short', day: 'numeric' });
      }
    };

    function slugify(str) {
      return str
        .normalize('NFD')
        .replace(/\p{Diacritic}/gu, '')
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '');
    }

    function humanizeName(name) {
      return name
        .replace(/[_-]+/g, ' ')
        .replace(/\s+/g, ' ')
        .trim()
        .replace(/\b\w/g, letter => letter.toUpperCase());
    }

    function setContactNote() {
      contactNoteEl.innerHTML = `Si tenés algún parcial, final o material mandalo a <strong><a href="mailto:${CONTACT_EMAIL}">${CONTACT_EMAIL}</a></strong> y lo sumamos.`;
    }

    function applyTheme(theme, { persist = true } = {}) {
      const root = document.documentElement;
      const next = theme === 'light' ? 'light' : 'dark';
      root.setAttribute('data-theme', next);
      const label = next === 'light' ? 'Tema claro' : 'Tema oscuro';
      const emoji = next === 'light' ? '☀️' : '🌙';
      themeToggleEl.querySelector('.label').textContent = label;
      themeToggleEl.querySelector('span[aria-hidden="true"]').textContent = emoji;
      themeToggleEl.setAttribute('aria-pressed', next === 'light' ? 'true' : 'false');
      if (persist) {
        try {
          localStorage.setItem(STORAGE_KEY_THEME, next);
        } catch (error) {
          console.warn('No se pudo guardar la preferencia de tema', error);
        }
      }
    }

    function getStoredTheme() {
      let stored = null;
      try {
        stored = localStorage.getItem(STORAGE_KEY_THEME);
      } catch (error) {
        console.warn('No se pudo leer la preferencia de tema', error);
        return null;
      }
      if (stored === 'light' || stored === 'dark') {
        return stored;
      }
      return null;
    }

    function getPreferredTheme() {
      const stored = getStoredTheme();
      if (stored) {
        return stored;
      }
      if (prefersLightScheme) {
        return prefersLightScheme.matches ? 'light' : 'dark';
      }
      return 'dark';
    }

    function setThemeFromToggle() {
      const current = document.documentElement.getAttribute('data-theme') === 'light' ? 'light' : 'dark';
      const next = current === 'dark' ? 'light' : 'dark';
      applyTheme(next);
    }

    function pathToHash(pathSegments) {
      if (!pathSegments.length) return '#/';
      return '#/' + pathSegments.map(seg => encodeURIComponent(seg)).join('/');
    }

    function hashToPath(hash) {
      if (!hash) return [];
      const cleaned = hash.replace(/^#\/?/, '');
      if (!cleaned) return [];
      return cleaned.split('/').filter(Boolean).map(seg => decodeURIComponent(seg));
    }

    function findNode(pathSegments) {
      let node = datasetRoot;
      for (const segment of pathSegments) {
        if (!node || !Array.isArray(node.children)) return null;
        const slug = slugify(segment);
        node = node.children.find(child => slugify(child.name) === slug);
        if (!node) return null;
      }
      return node;
    }

    function sortItems(items, mode) {
      const sorted = [...items];
      sorted.sort((a, b) => {
        if (a.type !== b.type) {
          return a.type === 'dir' ? -1 : 1;
        }
        if (mode === 'date') {
          const dateA = a.date ? Date.parse(a.date) : 0;
          const dateB = b.date ? Date.parse(b.date) : 0;
          return dateB - dateA;
        }
        return a.name.localeCompare(b.name, 'es', { sensitivity: 'base' });
      });
      return sorted;
    }

    function renderBreadcrumbs(pathSegments) {
      breadcrumbsEl.innerHTML = '';
      const frag = document.createDocumentFragment();

      const rootLink = document.createElement('a');
      rootLink.href = '#/';
      rootLink.textContent = 'Inicio';
      rootLink.addEventListener('click', (ev) => {
        ev.preventDefault();
        updatePath([]);
      });
      frag.appendChild(rootLink);

      let cumulative = [];
      for (const segment of pathSegments) {
        cumulative = [...cumulative, segment];
        const sep = document.createElement('span');
        sep.setAttribute('aria-hidden', 'true');
        sep.textContent = '›';
        frag.appendChild(sep);

        const link = document.createElement('a');
        link.href = pathToHash(cumulative);
        link.textContent = segment;
        link.addEventListener('click', (ev) => {
          ev.preventDefault();
          updatePath(cumulative);
        });
        frag.appendChild(link);
      }

      breadcrumbsEl.appendChild(frag);
    }

    function renderList(node) {
      if (!node) return;
      const filter = searchTerm.trim().toLowerCase();
      const items = Array.isArray(node.children) ? node.children.filter(Boolean) : [];
      let filtered = items;

      if (filter) {
        filtered = items.filter(item => item.name.toLowerCase().includes(filter));
      }

      const sorted = sortItems(filtered, sortMode);

      listingBodyEl.innerHTML = '';

      if (!sorted.length) {
        emptyStateEl.hidden = false;
        return;
      }

      emptyStateEl.hidden = true;

      const rowsFrag = document.createDocumentFragment();
      for (const item of sorted) {
        const tr = document.createElement('tr');

        const nameTd = document.createElement('td');
        const nameCell = document.createElement('div');
        nameCell.className = 'cell-name';
        nameCell.innerHTML = icons[item.ext === 'pdf' ? 'pdf' : item.type === 'dir' ? 'folder' : 'file'];

        if (item.type === 'dir') {
          const link = document.createElement('button');
          link.type = 'button';
          link.textContent = item.name;
          link.addEventListener('click', () => {
            updatePath([...currentPath, item.name]);
          });
          nameCell.appendChild(link);
        } else {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.textContent = item.name;
          btn.addEventListener('click', () => openPreview(item));
          nameCell.appendChild(btn);
        }

        nameTd.appendChild(nameCell);

        const typeTd = document.createElement('td');
        const badge = document.createElement('span');
        badge.className = 'badge';
        badge.textContent = item.type === 'dir' ? 'Carpeta' : (item.ext || 'Archivo').toUpperCase();
        typeTd.appendChild(badge);

        const dateTd = document.createElement('td');
        dateTd.textContent = formatters.date(item.date);

        tr.appendChild(nameTd);
        tr.appendChild(typeTd);
        tr.appendChild(dateTd);
        rowsFrag.appendChild(tr);
      }

      listingBodyEl.appendChild(rowsFrag);
    }

    function updatePath(nextPath, { fromHash = false } = {}) {
      const node = findNode(nextPath);
      if (!node) {
        console.warn('Ruta no encontrada, volviendo al inicio');
        currentPath = [];
        currentNode = datasetRoot;
        renderBreadcrumbs(currentPath);
        renderList(currentNode);
        if (!fromHash) {
          history.replaceState(null, '', pathToHash(currentPath));
        }
        return;
      }

      currentPath = nextPath;
      currentNode = node;
      renderBreadcrumbs(currentPath);
      renderList(currentNode);

      if (!fromHash) {
        history.pushState(null, '', pathToHash(currentPath));
      }
    }

    function syncFromHash() {
      const pathSegments = hashToPath(location.hash);
      updatePath(pathSegments, { fromHash: true });
    }

    async function loadDataset() {
      const response = await fetch(DATA_URL, { cache: 'no-cache' });
      if (!response.ok) throw new Error('No se pudo cargar index.json');
      const data = await response.json();
      datasetRoot = data;
      currentNode = data;
      currentPath = [];
      renderBreadcrumbs(currentPath);
      renderList(currentNode);
      if (!location.hash || location.hash === '#') {
        history.replaceState(null, '', '#/');
      } else {
        syncFromHash();
      }
    }

    function closeOverlay() {
      if (!isOverlayOpen) return;
      isOverlayOpen = false;
      activePreviewToken += 1;
      overlayEl.classList.remove('is-visible');
      overlayEl.hidden = true;
      document.body.classList.remove('has-overlay');
      overlayBodyEl.setAttribute('aria-live', 'off');
      while (overlayBodyEl.firstChild) {
        overlayBodyEl.removeChild(overlayBodyEl.firstChild);
      }
      overlayLoaderEl.hidden = true;
      overlayBodyEl.appendChild(overlayLoaderEl);
      if (lastFocusedElement) {
        lastFocusedElement.focus({ preventScroll: false });
      }
      overlayEl.removeEventListener('click', onOverlayBackdropClick);
      document.removeEventListener('keydown', onOverlayKeydown);
    }

    function onOverlayBackdropClick(event) {
      if (event.target === overlayEl) {
        closeOverlay();
      }
    }

    function onOverlayKeydown(event) {
      if (event.key === 'Escape') {
        event.preventDefault();
        closeOverlay();
      }
      if (event.key === 'Tab') {
        const focusable = overlayEl.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
        if (!focusable.length) return;
        const first = focusable[0];
        const last = focusable[focusable.length - 1];
        if (event.shiftKey && document.activeElement === first) {
          event.preventDefault();
          last.focus();
        } else if (!event.shiftKey && document.activeElement === last) {
          event.preventDefault();
          first.focus();
        }
      }
    }

    async function ensurePdfJs() {
      if (pdfjsReady) return window.pdfjsLib;
      if (!window.pdfjsLib) {
        await new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.min.js';
          script.onload = resolve;
          script.onerror = () => reject(new Error('No se pudo cargar PDF.js'));
          document.head.appendChild(script);
        });
      }
      window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.worker.min.js';
      pdfjsReady = true;
      return window.pdfjsLib;
    }
    async function renderWithPdfJs(fileNode, fileUrl, token) {
      overlayLoaderEl.hidden = false;
      const container = document.createElement('div');
      container.className = 'pdf-pages';
      overlayBodyEl.appendChild(container);

      try {
        const pdfjsLib = await ensurePdfJs();
        const loadingTask = pdfjsLib.getDocument(fileUrl);
        const pdfDocument = await loadingTask.promise;
        const total = pdfDocument.numPages;

        for (let pageNumber = 1; pageNumber <= total; pageNumber += 1) {
          if (token !== activePreviewToken) {
            return;
          }
          const page = await pdfDocument.getPage(pageNumber);
          const viewport = page.getViewport({ scale: 1.2 });
          const canvas = document.createElement('canvas');
          canvas.width = viewport.width;
          canvas.height = viewport.height;
          const context = canvas.getContext('2d');
          const renderContext = {
            canvasContext: context,
            viewport
          };
          const pageWrapper = document.createElement('div');
          pageWrapper.className = 'pdf-page';
          pageWrapper.appendChild(canvas);
          if (token !== activePreviewToken) {
            return;
          }
          container.appendChild(pageWrapper);
          await page.render(renderContext).promise;
        }
        if (token !== activePreviewToken) {
          return;
        }
        overlayLoaderEl.hidden = true;
      } catch (error) {
        console.warn('PDF.js no disponible, usando iframe fallback', error);
        if (container.isConnected) {
          overlayBodyEl.removeChild(container);
        }
        overlayLoaderEl.hidden = true;
        if (token === activePreviewToken) {
          renderWithIframeFallback(fileUrl, token);
        }
      }
    }

    function renderWithIframeFallback(fileUrl, token) {
      if (token !== activePreviewToken) {
        return;
      }
      const iframe = document.createElement('iframe');
      iframe.src = `${fileUrl}#zoom=page-width`;
      iframe.title = 'Vista previa del archivo PDF';
      iframe.setAttribute('loading', 'lazy');
      iframe.style.height = '100%';
      overlayBodyEl.appendChild(iframe);
    }

    async function openPreview(fileNode) {
      if (!fileNode || !fileNode.file) return;
      const token = activePreviewToken + 1;
      activePreviewToken = token;
      isOverlayOpen = true;
      lastFocusedElement = document.activeElement;
      overlayTitleEl.textContent = fileNode.name;
      overlayBodyEl.innerHTML = '';
      overlayBodyEl.setAttribute('aria-live', 'polite');
      overlayLoaderEl.hidden = true;
      overlayBodyEl.appendChild(overlayLoaderEl);

      const fileUrl = fileNode.url || `files/${fileNode.file}`;

      overlayEl.hidden = false;
      requestAnimationFrame(() => {
        overlayEl.classList.add('is-visible');
      });
      document.body.classList.add('has-overlay');
      overlayCloseEl.focus({ preventScroll: true });
      overlayEl.addEventListener('click', onOverlayBackdropClick);
      document.addEventListener('keydown', onOverlayKeydown);

      try {
        await renderWithPdfJs(fileNode, fileUrl, token);
      } catch (error) {
        console.warn('Fallo al renderizar con PDF.js, se usará iframe', error);
        overlayLoaderEl.hidden = true;
        renderWithIframeFallback(fileUrl, token);
      }
    }

    function bindEvents() {
      searchInputEl.addEventListener('input', () => {
        searchTerm = searchInputEl.value;
        renderList(currentNode);
      });

      sortSelectEl.addEventListener('change', () => {
        sortMode = sortSelectEl.value;
        renderList(currentNode);
      });

      upButtonEl.addEventListener('click', () => {
        if (!currentPath.length) return;
        const next = currentPath.slice(0, -1);
        updatePath(next);
      });
      if (themeToggleEl) {
        themeToggleEl.addEventListener('click', setThemeFromToggle);
      } else {
        console.warn('No encontramos el botón de tema en el DOM');
      }
      if (prefersLightScheme) {
        const handleSchemeChange = (event) => {
          if (getStoredTheme()) {
            return;
          }
          applyTheme(event.matches ? 'light' : 'dark', { persist: false });
        };
        if (typeof prefersLightScheme.addEventListener === 'function') {
          prefersLightScheme.addEventListener('change', handleSchemeChange);
        } else if (typeof prefersLightScheme.addListener === 'function') {
          prefersLightScheme.addListener(handleSchemeChange);
        }
      }
      overlayCloseEl.addEventListener('click', (event) => {
        event.preventDefault();
        event.stopPropagation();
        closeOverlay();
      });

      window.addEventListener('hashchange', syncFromHash);
    }

    async function init() {

      const storedTheme = getStoredTheme();
      const initialTheme = storedTheme ?? getPreferredTheme();
      applyTheme(initialTheme, { persist: Boolean(storedTheme) });
      setContactNote();
      bindEvents();
      try {
        await loadDataset();
      } catch (error) {
        console.error(error);
        emptyStateEl.hidden = false;
        emptyStateEl.textContent = 'No pudimos cargar la estructura. Revisá que index.json exista.';
      }
    }

    init();
  </script>
</body>
</html>
